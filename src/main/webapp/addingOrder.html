<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Adding Order</title>
<link rel="stylesheet" type="text/css" href="styles/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="styles/bar.css" />
<script type="text/javascript" src="js/jquery-2.1.3.min.js"></script>
<script type="text/javascript">
	isUserAuthenticated = false;

	$(document).ready(function() {
		$.ajax({
			url : 'rest/user/authenticated',
			type : "GET",
			dataType : "json",
			statusCode : {
				200 : function() {
					$(".login_register").hide();
					isUserAuthenticated = true;
				},
				404 : function() {
					$('.logout').hide();
				}
			}
		});

		

		var data = [];

		drawTableWithItems();

		$.ajax({
			url : 'rest/user/current',
			type : "GET",
			dataType : "text"
		}).always(function(data) {
			if (typeof data != 'undefined') {
				$("#user-holder").text(data);
			} else {
				$(".welcome-greeting").hide();
			}
		});
	});

	function drawTableWithItems() {
		$.ajax({
			url : 'rest/item/items',
			type : "GET",
			dataType : "json",
			success : function(data) {
// 				if (typeof data != 'undefined') {
					renderTable(data);
			/* 	} else {
					alert("Access to items forbidden!");
					return;
				} */
			}
		});
	}

	function renderTable(data) {
		$("#items_table tr").remove();
		var items = data.item;
		console.log(data);
		for (var i = 0; i < items.length; i++) {
			renderRow(items[i]);
			console.log("row rendered");
		}
	}

	function renderRow(rowData) {
		var row = $("<tr />");
		row.attr("id")
		$("#items_table").append(row);
		row.append($("<td>" + rowData.id + "</td>"));
		row.append($("<td>" + rowData.itemName + "</td>"));
		row.append($("<td>" + rowData.price + "</td>"));
		row.append($("<td>" + rowData.type + "</td>"));
		row.append($("<td>" + rowData.description + "</td>"));

		if (isUserAuthenticated && rowData.amount > 0) {
			var addTd = $("<td />");
			var link = $("<button>Add</button>");
			link.attr("id", rowData.id);
			AddTd.append(link);
			row.append(acceptTd);
			link.click(function() {
				listOfItemsToOrder.push(this.id)
			});
		} else {
			row.append($("<td/>"));
		}
	}

	function order() {
		var formUrl = $("#order_form").attr("action");
		var tableNumber = $("#tableNumber")[0].value;
		
		if (tableNumber == "") {
			alert("Please fill table name");
			return;
		}

		$.ajax({
			url : 'rest/order/order',
			type : "POST",
			contentType : "application/json;charset=UTF-8",
			data : JSON.stringify(data)
		}).success(function(data) {
			$("#order_form").attr("action", "index.html");
			$("#order_form").submit();
		}).fail(function(data) {
			$("#order_form").attr("action", "addOrder.html");
		});
	}
</script>
</head>
<body>
	<div align="left">
		<h2>
			<a href="index.html">Simple Bar Management</a>
		</h2>
	</div>
	<hr>
	<h1 align="center">
		<b>ORDERING</b>
	</h1>
	<div>
		<table id="items_table" class="table">
			<tr>
				<th>Title</th>
				<th>Author</th>
				<th>ISBN</th>
				<th>Amount</th>
				<th>Action</th>
			</tr>
		</table>
	</div>


	<div class="login_register">
		<a href="addOrder.html" class="add_order_form">Add Order</a> 
		<a href="addItem.html" class="add_item_form">Add Items</a> 
		<a href="login.html" class="register_form"> Log in </a>
	</div>

	<form id="order_form" role="form" method="post">
		<div class="form-group">
			<label for="tableNumber">Table Number:</label> <input type="text"
				class="form-control" name="tableNumber" id="tableNumber" value="">
		</div>

		<div class="form-group">
			<label for="email">Count:</label> <input type="email"
				class="form-control" name="email" id="email" value="">
		</div>

		<button type="reset" class="btn btn-default" id="reset_register">Reset</button>
		<button type="button" onclick="order()" class="btn btn-default">Submit</button>
	</form>

</body>
</html>