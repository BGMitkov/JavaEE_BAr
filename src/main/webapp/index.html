<!DOCTYPE html>
<html>
<head>
<title>Java EE Exercise 2</title>
<link rel="stylesheet" type="text/css" href="styles/bootstrap.css" />
<link rel="stylesheet" type="text/css" href="styles/bar.css" />
<script type="text/javascript" src="js/jquery-2.1.3.min.js"></script>
<script type="text/javascript">
	isUserAuthenticated = false;

	$(document).ready(function() {
		$.ajax({
			url : 'rest/user/authenticated',
			type : "GET",
			dataType : "json",
			statusCode : {
				200 : function() {
					$(".login_register").hide();
					isUserAuthenticated = true;
				},
				404 : function() {
					$('.logout').hide();
				}
			}
		});
		drawTableWithOrders();

		$.ajax({
			url : 'rest/user/current',
			type : "GET",
			dataType : "text"
		}).always(function(data) {
			if (typeof data != 'undefined') {
				$("#user-holder").text(data);
			} else {
				$(".welcome-greeting").hide();
			}
		});
	});

	function drawTableWithOrders() {
		$.ajax({
			url : 'rest/order',
			type : "GET",
			dataType : "json",
			success : function(data) {
				if (data != null) {
					renderTable(data);
				}
				else {
					alert("Access to orders forbidden!");
					return;
				}
			}
		});
	}

	function renderTable(data) {
		$("#orders_table tr").remove();
		var orders = data.order;
		for (var i = 0; i < orders.length; i++) {
			renderRow(orders[i]);
		}
	}

	function renderRow(rowData) {
		var row = $("<tr />");
		$("#orders_table").append(row);
		row.append($("<td>" + rowData.executor.userName + "</td>"));
		row.append($("<td>" + rowData.status + "</td>"));
		row.append($("<td>" + rowData.dateOfOrder + "</td>"));
		row.append($("<td>" + rowData.dateOfAcceptance + "</td>"));
		if (isUserAuthenticated && rowData.amount > 0) {
			var acceptTd = $("<td />");
			var link = $("<button>Accept</button>");
			AcceptTd.append(link);
			row.append(acceptTd);
			link.click(function() {
				$.ajax({
					url : 'rest/order/accept?id=' + rowData.id,
					type : "PUT",
					dataType : "json",
					success : drawTableWithBooks
				});
			});
		} else {
			row.append($("<td/>"));
		}
	}

	function logout() {
		$.ajax({
			url : 'rest/user/logout',
			type : "GET",
			dataType : "text"
		}).always(function(data) {
			window.location.replace("login.html");
		});
	}
</script>

</head>
<body>
<<<<<<< HEAD
	<div align="left">
		<h2><a href="index.html">Simple Bar Management</a></h2>	
=======
	<div align="center">
		<h1>Orders Application</h1>
>>>>>>> a3c553f9bde3d09a7c278a13ed3e95ae9b72c0a7
	</div>
	<hr>
	<div>
		<table id="orders_table" class="table">
			<tr>
				<th>Title</th>
				<th>Author</th>
				<th>ISBN</th>
				<th>Amount</th>
				<th>Action</th>
			</tr>
		</table>
	</div>

	<div class="login_register">
<<<<<<< HEAD
		<a href="addingOrder.html" class="add_order_form">Add Order</a>
		<a href="addItem.html" class="add_item_form">Add Items</a>
		<a href="login.html" class="login_form"> Log in </a>
        <a href="register.html" class="register_form"> Register </a>
=======
		<a href="login.html" class="login_form"> Log in </a> <a
			href="register.html" class="register_form"> Register </a>
>>>>>>> a3c553f9bde3d09a7c278a13ed3e95ae9b72c0a7
	</div>
	<div class="logout">
		<a onclick="logout()"> Logout </a>
	</div>
	<div class="welcome-greeting">
		Welcome <span id="user-holder"></span> !
	</div>
</body>
</html>